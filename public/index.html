<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Планировщик</title>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #f7fbff; color: #0b1b14; }
    .wrap { padding: 16px; }
    .card { background: #ffffff; border-radius: 16px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.06); }
    .h1 { font-size: 18px; font-weight: 700; margin: 0 0 8px; }
    .muted { opacity: 0.75; line-height: 1.35; }
    .pill { display: inline-block; padding: 6px 10px; border-radius: 999px; background: #e6f6ef; color: #0f4a2d; font-weight: 600; font-size: 12px; }
    .btn { margin-top: 12px; width: 100%; border: 0; border-radius: 14px; padding: 12px 14px; font-size: 15px; font-weight: 700; background: #d7f3e6; color: #0f4a2d; }
    .small { font-size: 12px; margin-top: 10px; opacity: 0.7; }
  </style>
<script src="https://telegram.org/js/telegram-web-app.js"></script> </head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="pill">v1 · скелет работает</div>
      <h1 class="h1">Помощник Павел — Mini App</h1>
      <div class="muted">
        Если ты это видишь — значит хостинг и приложение запускаются правильно.
        Дальше мы добавим проекты, задачи, сферы, цвета и бота.
      </div>
      <button class="btn" id="btn">Проверить Telegram WebApp</button>
      <button class="btn" id="create">Создать задачу</button>
      <div id="createBox" style="margin-top:12px;"></div>
      <div class="small" id="info"></div>
      <div id="tasks" style="margin-top:12px;"></div>
    </div>
  </div>
  <script>
  const info = document.getElementById("info");
  const btn = document.getElementById("btn");
  const createBtn = document.getElementById("create");
  const tasksEl = document.getElementById("tasks");
  const createBox = document.getElementById("createBox");

  let userId = null;
  let view = "in_work"; // in_work | recorded

  const praise = [
  "Чётко.",
  "Красиво сделал.",
  "Вот это ход.",
  "Уверенно.",
  "Засчитано с бонусом.",
  "Опасно красиво.",
  "Сильный шаг.",
  "Ты на уровне.",
  "Это прогресс.",
  "Ровно в цель.",
  "Без суеты.",
  "Хорош.",
  "Очень хорошо.",
  "Это было вкусно.",
  "Да. Вот так.",
  "Сделано — и точка.",
  "Ты растёшь.",
  "Смело. И правильно.",
  "Это уровень."
];
  let lastPraises = [];

function pickPraise() {
  if (praise.length <= 3) {
    return praise[Math.floor(Math.random() * praise.length)];
  }

  let p;
  do {
    p = praise[Math.floor(Math.random() * praise.length)];
  } while (lastPraises.includes(p));

  lastPraises.push(p);
  if (lastPraises.length > 3) {
    lastPraises.shift();
  }

  return p;
}


  function show(msg) {
    info.textContent = msg;
  }
const SPHERES = ["Работа","Деньги","Тело","Отношения","Дом","Развитие","Творчество","Социум","Отдых","Ценности"];
const DIFFS = [
  { n: 1, label: "Голубой" },
  { n: 2, label: "Зелёный" },
  { n: 3, label: "Жёлтый" },
  { n: 4, label: "Оранжевый" },
  { n: 5, label: "Красный" },
  { n: 6, label: "Фиолетовый" }
];

let draft = { sphere: null, difficulty: null, text: "", importance: null };

function renderCreateUI() {
  if (!userId) {
    createBox.innerHTML = `<div class="small">Сначала нажми «Проверить Telegram WebApp».</div>`;
    return;
  }

  const sphereBtns = SPHERES.map(s => `
    <button data-sphere="${s}" class="sbtn" style="padding:10px 12px;border:0;border-radius:14px;background:${draft.sphere===s?"#d7f3e6":"#eef7ff"};font-weight:700;">
      ${s}
    </button>
  `).join("");

  const diffBtns = DIFFS.map(d => `
    <button data-diff="${d.n}" class="dbtn" style="padding:10px 12px;border:0;border-radius:14px;background:${draft.difficulty===d.n?"#d7f3e6":"#ffffff"};box-shadow:0 6px 18px rgba(0,0,0,0.06);font-weight:800;">
      ${d.n}
    </button>
  `).join("");

  const impBtns = [1,2,3,4].map(n => `
    <button data-imp="${n}" class="ibtn" style="padding:10px 12px;border:0;border-radius:14px;background:${draft.importance===n?"#d7f3e6":"#ffffff"};box-shadow:0 6px 18px rgba(0,0,0,0.06);font-weight:800;color:#0f4a2d;">
      ${n}
    </button>
  `).join("");

  createBox.innerHTML = `
    <div class="card" style="margin-top:12px;">
      <div class="h1">Новая задача</div>

      <div class="muted" style="margin-top:8px;">1) Сфера</div>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;">${sphereBtns}</div>

      <div class="muted" style="margin-top:12px;">2) Сложность (1–6)</div>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;">${diffBtns}</div>

      <div class="muted" style="margin-top:12px;">3) Текст</div>
      <input id="ttext" placeholder="Например: оплатить счёт" value="${draft.text || ""}"
        style="width:100%;margin-top:8px;padding:12px 12px;border-radius:14px;border:1px solid rgba(0,0,0,0.08);font-size:15px;" />

      <div class="muted" style="margin-top:12px;">4) Важность (1–4)</div>
      <div style="display:flex;gap:8px;margin-top:8px;">${impBtns}</div>

      <button id="saveTask" class="btn" style="margin-top:12px;">Сохранить (записать)</button>
      <button id="takeTask" class="btn" style="margin-top:8px;">Взять в работу</button>

      <div class="small" style="margin-top:8px;opacity:.75;">
        Сначала «записать», потом «взять в работу». Даты добавим следующим шагом.
      </div>
    </div>
  `;

  // handlers
  createBox.querySelectorAll(".sbtn").forEach(b => b.addEventListener("click", () => {
    draft.sphere = b.dataset.sphere;
    renderCreateUI();
  }));

  createBox.querySelectorAll(".dbtn").forEach(b => b.addEventListener("click", () => {
    draft.difficulty = Number(b.dataset.diff);
    renderCreateUI();
  }));

  createBox.querySelectorAll(".ibtn").forEach(b => b.addEventListener("click", () => {
    draft.importance = Number(b.dataset.imp);
    renderCreateUI();
  }));

  const ttext = createBox.querySelector("#ttext");
  ttext.addEventListener("input", () => {
    draft.text = ttext.value;
  });

  createBox.querySelector("#saveTask").addEventListener("click", async () => {
    if (!draft.sphere || !draft.difficulty || !draft.importance || !draft.text.trim()) {
      show("Заполни: сфера, сложность, текст, важность.");
      return;
    }
    const r = await fetch("/api/tasks", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId,
        sphere: draft.sphere,
        difficulty: draft.difficulty,
        importance: draft.importance,
        text: draft.text.trim()
      })
    });
    const data = await r.json();
    if (data.error) { show("Ошибка: " + data.error); return; }
    show("Записал ✅ Теперь можешь взять в работу.");
    draft._lastCreatedId = data.task.id;
  });

  createBox.querySelector("#takeTask").addEventListener("click", async () => {
    const id = draft._lastCreatedId;
    if (!id) { show("Сначала нажми «Сохранить (записать)»."); return; }
    await fetch(`/api/tasks/${id}/take`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, dueDate: null, dueTime: null })
    });
    toast("В работе.");
    view = "in_work";
    await renderTasks();
  });
}

  function confettiLite() {
    // Очень лёгкий "салют" без библиотек
    const n = 40;
    for (let i = 0; i < n; i++) {
      const dot = document.createElement("div");
      dot.style.position = "fixed";
      dot.style.left = (50 + (Math.random() * 20 - 10)) + "vw";
      dot.style.top = (30 + (Math.random() * 10 - 5)) + "vh";
      dot.style.width = "6px";
      dot.style.height = "6px";
      dot.style.borderRadius = "999px";
      dot.style.background = "rgba(60, 160, 120, 0.8)";
      dot.style.zIndex = 9999;
      dot.style.transform = "translate(-50%, -50%)";
      dot.style.transition = "transform 700ms ease, opacity 700ms ease";
      document.body.appendChild(dot);

      requestAnimationFrame(() => {
        dot.style.opacity = "0";
        dot.style.transform =
          `translate(${(Math.random() * 160 - 80)}px, ${(Math.random() * 220 - 120)}px)`;
      });

      setTimeout(() => dot.remove(), 1400);
    }
  }

  function toast(text) {
    const t = document.createElement("div");
    t.textContent = text;
    t.style.position = "fixed";
    t.style.left = "50%";
    t.style.bottom = "90px";
    t.style.transform = "translateX(-50%)";
    t.style.background = "#ffffff";
    t.style.borderRadius = "999px";
    t.style.padding = "10px 14px";
    t.style.boxShadow = "0 10px 30px rgba(0,0,0,0.12)";
    t.style.fontWeight = "700";
    t.style.zIndex = 9999;
    t.style.opacity = "0";
    t.style.transition = "opacity 200ms ease";
    document.body.appendChild(t);
    requestAnimationFrame(() => (t.style.opacity = "1"));
    setTimeout(() => {
      t.style.opacity = "0";
      setTimeout(() => t.remove(), 250);
    }, 2200);
  }
function openTakeDialog() {
  return new Promise((resolve) => {
    const overlay = document.createElement("div");
    overlay.style.position = "fixed";
    overlay.style.left = "0";
    overlay.style.top = "0";
    overlay.style.right = "0";
    overlay.style.bottom = "0";
    overlay.style.background = "rgba(0,0,0,0.35)";
    overlay.style.zIndex = "9999";
    overlay.style.display = "flex";
    overlay.style.alignItems = "center";
    overlay.style.justifyContent = "center";
    overlay.style.padding = "16px";

    const box = document.createElement("div");
    box.style.width = "100%";
    box.style.maxWidth = "420px";
    box.style.background = "#ffffff";
    box.style.borderRadius = "16px";
    box.style.boxShadow = "0 20px 60px rgba(0,0,0,0.18)";
    box.style.padding = "14px";

    box.innerHTML = `
      <div style="font-weight:800;font-size:16px;margin-bottom:8px;">Взять в работу</div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
        <button id="m1" style="flex:1;border:0;border-radius:14px;padding:10px 12px;font-weight:800;background:#d7f3e6;color:#0f4a2d;">Без даты</button>
        <button id="m2" style="flex:1;border:0;border-radius:14px;padding:10px 12px;font-weight:800;background:#eef7ff;">С датой</button>
        <button id="m3" style="flex:1;border:0;border-radius:14px;padding:10px 12px;font-weight:800;background:#eef7ff;">Дата+время</button>
      </div>

      <div id="dateWrap" style="display:none;margin-top:8px;">
        <div style="font-size:12px;opacity:.75;margin-bottom:6px;">Дата</div>
        <input id="dueDate" type="date" style="width:100%;padding:12px;border-radius:14px;border:1px solid rgba(0,0,0,0.12);" />
      </div>

      <div id="timeWrap" style="display:none;margin-top:10px;">
        <div style="font-size:12px;opacity:.75;margin-bottom:6px;">Время</div>
        <input id="dueTime" type="time" style="width:100%;padding:12px;border-radius:14px;border:1px solid rgba(0,0,0,0.12);" />
      </div>

      <div style="display:flex;gap:8px;margin-top:12px;">
        <button id="cancel" style="flex:1;border:0;border-radius:14px;padding:10px 12px;font-weight:800;background:#f3f6fb;">Отмена</button>
        <button id="ok" style="flex:1;border:0;border-radius:14px;padding:10px 12px;font-weight:800;background:#d7f3e6;color:#0f4a2d;">Готово</button>
      </div>
    `;

    overlay.appendChild(box);
    document.body.appendChild(overlay);

    let mode = "1"; // 1=без даты, 2=дата, 3=дата+время
    const dateWrap = box.querySelector("#dateWrap");
    const timeWrap = box.querySelector("#timeWrap");

    function setMode(m) {
      mode = m;
      box.querySelector("#m1").style.background = (m==="1") ? "#d7f3e6" : "#eef7ff";
      box.querySelector("#m2").style.background = (m==="2") ? "#d7f3e6" : "#eef7ff";
      box.querySelector("#m3").style.background = (m==="3") ? "#d7f3e6" : "#eef7ff";

      dateWrap.style.display = (m==="2" || m==="3") ? "block" : "none";
      timeWrap.style.display = (m==="3") ? "block" : "none";
    }

    box.querySelector("#m1").onclick = () => setMode("1");
    box.querySelector("#m2").onclick = () => setMode("2");
    box.querySelector("#m3").onclick = () => setMode("3");
    setMode("1");

    box.querySelector("#cancel").onclick = () => {
      overlay.remove();
      resolve(null);
    };

    box.querySelector("#ok").onclick = () => {
      const dueDate = box.querySelector("#dueDate").value || null;
      const dueTime = box.querySelector("#dueTime").value || null;

      if ((mode === "2" || mode === "3") && !dueDate) {
        // простая защита
        box.querySelector("#dueDate").focus();
        return;
      }
      if (mode === "3" && !dueTime) {
        box.querySelector("#dueTime").focus();
        return;
      }

      overlay.remove();
      resolve({
        dueDate: (mode === "1") ? null : dueDate,
        dueTime: (mode === "3") ? dueTime : null
      });
    };
  });
}

async function takeWithSchedule(taskId) {
  const picked = await openTakeDialog();
  if (!picked) return;

  await fetch(`/api/tasks/${taskId}/take`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ userId, dueDate: picked.dueDate, dueTime: picked.dueTime })
  });

  toast("В работе.");
  view = "in_work";
  await renderTasks();
}


  if (mode === "3") {
    dueTime = prompt("Введи время в формате ЧЧ:ММ:");
    if (!dueTime) return;
  }

  await fetch(`/api/tasks/${taskId}/take`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ userId, dueDate, dueTime })
  });

  toast("В работе.");
  view = "in_work";
  await renderTasks();
}

  async function apiGetTasks() {
  const r = await fetch(`/api/tasks?userId=${encodeURIComponent(userId)}&status=${encodeURIComponent(view)}`);
  const data = await r.json();
  return data.tasks || [];
}

  async function apiCreateAndTakeTask() {
    const body = {
      userId,
      sphere: "Деньги",
      difficulty: 3,
      importance: 1,
      text: "Тест: оплатить счёт"
    };
    const r = await fetch("/api/tasks", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    const created = await r.json();
    const task = created.task;

    await fetch(`/api/tasks/${task.id}/take`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, dueDate: null, dueTime: null })
    });
  }

  async function apiDone(taskId) {
    await fetch(`/api/tasks/${taskId}/done`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId })
    });
  }

  function difficultyColor(d) {
    // пока только для маркера слева (позже сделаем твои точные цвета)
    const map = {
      1: "#7fd3ff", // голубой
      2: "#7be3b0", // зелёный
      3: "#ffe27a", // жёлтый
      4: "#ffbf73", // оранжевый
      5: "#ff7f7f", // красный
      6: "#c9a4ff"  // фиолетовый
    };
    return map[d] || "#cfe9dd";
  }

  function renderTaskRow(t) {
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.gap = "10px";
    row.style.padding = "12px";
    row.style.borderRadius = "14px";
    row.style.background = "#ffffff";
    row.style.boxShadow = "0 6px 18px rgba(0,0,0,0.06)";
    row.style.marginTop = "10px";

    const marker = document.createElement("div");
    marker.style.width = "8px";
    marker.style.height = "34px";
    marker.style.borderRadius = "999px";
    marker.style.background = difficultyColor(t.difficulty);

    const mid = document.createElement("div");
    mid.style.flex = "1";

    const top = document.createElement("div");
    top.style.display = "flex";
    top.style.alignItems = "baseline";
    top.style.gap = "10px";

    const imp = document.createElement("div");
    imp.textContent = String(t.importance);
    imp.style.fontWeight = "800";
    imp.style.color = "#0f4a2d"; // тёмно-зелёный
    imp.style.fontSize = "18px";

    const sphere = document.createElement("div");
    sphere.textContent = t.sphere;
    sphere.style.fontWeight = "700";
    sphere.style.opacity = "0.85";

    top.appendChild(imp);
    top.appendChild(sphere);

    const text = document.createElement("div");
    text.textContent = t.text;
    text.style.marginTop = "2px";
    text.style.fontSize = "15px";

    mid.appendChild(top);
    mid.appendChild(text);

  let right;
if (view === "in_work") {
  right = document.createElement("input");
  right.type = "checkbox";
  right.style.width = "22px";
  right.style.height = "22px";

  right.addEventListener("change", async () => {
    if (!right.checked) return;
    toast(pickPraise());
    confettiLite();
    await apiDone(t.id);
    await renderTasks();
  });
} else {
  right = document.createElement("button");
  right.textContent = "В работу";
  right.style.border = "0";
  right.style.borderRadius = "12px";
  right.style.padding = "10px 12px";
  right.style.fontWeight = "800";
  right.style.background = "#d7f3e6";
  right.style.color = "#0f4a2d";

 right.onclick = async () => {
  await takeWithSchedule(t.id);
};
}


    row.appendChild(marker);
    row.appendChild(mid);
    row.appendChild(right);

    return row;
  }

  async function renderTasks() {
    tasksEl.innerHTML = `
  <div style="display:flex;gap:8px;margin-top:10px;">
    <button id="vw1" class="btn" style="margin:0;background:${view==="in_work"?"#d7f3e6":"#eef7ff"};">В работе</button>
    <button id="vw2" class="btn" style="margin:0;background:${view==="recorded"?"#d7f3e6":"#eef7ff"};">Записанные</button>
  </div>
`;
document.getElementById("vw1").onclick = async () => { view = "in_work"; await renderTasks(); };
document.getElementById("vw2").onclick = async () => { view = "recorded"; await renderTasks(); };
    const tasks = await apiGetTasks();
   if (!tasks.length) {
  const emptyText = (view === "recorded")
    ? "Пока нет записанных задач."
    : "Пока нет задач в работе.";

  const empty = document.createElement("div");
  empty.className = "small";
  empty.style.marginTop = "10px";
  empty.textContent = emptyText;

  tasksEl.appendChild(empty);
  return;
}
    tasks.forEach(t => tasksEl.appendChild(renderTaskRow(t)));
  }

  btn.addEventListener("click", async () => {
    const tg = window.Telegram && window.Telegram.WebApp;
    if (!tg) {
      show("Telegram WebApp не обнаружен. Открой приложение через кнопку в чате с ботом.");
      return;
    }
    tg.ready();
    const user = tg.initDataUnsafe && tg.initDataUnsafe.user;
    if (!user) {
      show("Telegram WebApp подключён ✅ Но пользователь не передан.");
      return;
    }
    userId = String(user.id);
    show(`Telegram WebApp подключён ✅ Привет, ${user.first_name}! (id: ${userId})`);
    await renderTasks();
    renderCreateUI();
  });

  createBtn.addEventListener("click", async () => {
    if (!userId) {
      show("Сначала нажми «Проверить Telegram WebApp».");
      return;
    }
    await apiCreateAndTakeTask();
    await renderTasks();
  });
</script>


</body>
</html>
