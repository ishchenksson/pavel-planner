<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Планировщик</title>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #f7fbff; color: #0b1b14; }
    .wrap { padding: 16px; }
    .card { background: #ffffff; border-radius: 16px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.06); }
    .h1 { font-size: 18px; font-weight: 700; margin: 0 0 8px; }
    .muted { opacity: 0.75; line-height: 1.35; }
    .pill { display: inline-block; padding: 6px 10px; border-radius: 999px; background: #e6f6ef; color: #0f4a2d; font-weight: 600; font-size: 12px; }
    .btn { margin-top: 12px; width: 100%; border: 0; border-radius: 14px; padding: 12px 14px; font-size: 15px; font-weight: 700; background: #d7f3e6; color: #0f4a2d; }
    .small { font-size: 12px; margin-top: 10px; opacity: 0.7; }
  </style>
<script src="https://telegram.org/js/telegram-web-app.js"></script> </head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="pill">v1 · скелет работает</div>
      <h1 class="h1">Помощник Павел — Mini App</h1>
      <div class="muted">
        Если ты это видишь — значит хостинг и приложение запускаются правильно.
        Дальше мы добавим проекты, задачи, сферы, цвета и бота.
      </div>
      <button class="btn" id="btn">Проверить Telegram WebApp</button>
      <button class="btn" id="create">Создать тестовую задачу</button>
      <div class="small" id="info"></div>
      <div id="tasks" style="margin-top:12px;"></div>
    </div>
  </div>
  <script>
  const info = document.getElementById("info");
  const btn = document.getElementById("btn");
  const createBtn = document.getElementById("create");
  const tasksEl = document.getElementById("tasks");

  let userId = null;

  const praise = [
  "Чётко.",
  "Красиво сделал.",
  "Вот это ход.",
  "Уверенно.",
  "Засчитано с бонусом.",
  "Опасно красиво.",
  "Сильный шаг.",
  "Ты на уровне.",
  "Это прогресс.",
  "Ровно в цель.",
  "Без суеты.",
  "Хорош.",
  "Очень хорошо.",
  "Это было вкусно.",
  "Да. Вот так.",
  "Сделано — и точка.",
  "Ты растёшь.",
  "Смело. И правильно.",
  "Это уровень."
];
  let lastPraises = [];

function pickPraise() {
  if (praise.length <= 3) {
    return praise[Math.floor(Math.random() * praise.length)];
  }

  let p;
  do {
    p = praise[Math.floor(Math.random() * praise.length)];
  } while (lastPraises.includes(p));

  lastPraises.push(p);
  if (lastPraises.length > 3) {
    lastPraises.shift();
  }

  return p;
}


  function show(msg) {
    info.textContent = msg;
  }

  function confettiLite() {
    // Очень лёгкий "салют" без библиотек
    const n = 40;
    for (let i = 0; i < n; i++) {
      const dot = document.createElement("div");
      dot.style.position = "fixed";
      dot.style.left = (50 + (Math.random() * 20 - 10)) + "vw";
      dot.style.top = (30 + (Math.random() * 10 - 5)) + "vh";
      dot.style.width = "6px";
      dot.style.height = "6px";
      dot.style.borderRadius = "999px";
      dot.style.background = "rgba(60, 160, 120, 0.8)";
      dot.style.zIndex = 9999;
      dot.style.transform = "translate(-50%, -50%)";
      dot.style.transition = "transform 700ms ease, opacity 700ms ease";
      document.body.appendChild(dot);

      requestAnimationFrame(() => {
        dot.style.opacity = "0";
        dot.style.transform =
          `translate(${(Math.random() * 160 - 80)}px, ${(Math.random() * 220 - 120)}px)`;
      });

      setTimeout(() => dot.remove(), 1400);
    }
  }

  function toast(text) {
    const t = document.createElement("div");
    t.textContent = text;
    t.style.position = "fixed";
    t.style.left = "50%";
    t.style.bottom = "90px";
    t.style.transform = "translateX(-50%)";
    t.style.background = "#ffffff";
    t.style.borderRadius = "999px";
    t.style.padding = "10px 14px";
    t.style.boxShadow = "0 10px 30px rgba(0,0,0,0.12)";
    t.style.fontWeight = "700";
    t.style.zIndex = 9999;
    t.style.opacity = "0";
    t.style.transition = "opacity 200ms ease";
    document.body.appendChild(t);
    requestAnimationFrame(() => (t.style.opacity = "1"));
    setTimeout(() => {
      t.style.opacity = "0";
      setTimeout(() => t.remove(), 250);
    }, 2200);
  }

  async function apiGetTasks() {
    const r = await fetch(`/api/tasks?userId=${encodeURIComponent(userId)}`);
    const data = await r.json();
    return data.tasks || [];
  }

  async function apiCreateAndTakeTask() {
    const body = {
      userId,
      sphere: "Деньги",
      difficulty: 3,
      importance: 1,
      text: "Тест: оплатить счёт"
    };
    const r = await fetch("/api/tasks", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    const created = await r.json();
    const task = created.task;

    await fetch(`/api/tasks/${task.id}/take`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, dueDate: null, dueTime: null })
    });
  }

  async function apiDone(taskId) {
    await fetch(`/api/tasks/${taskId}/done`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId })
    });
  }

  function difficultyColor(d) {
    // пока только для маркера слева (позже сделаем твои точные цвета)
    const map = {
      1: "#7fd3ff", // голубой
      2: "#7be3b0", // зелёный
      3: "#ffe27a", // жёлтый
      4: "#ffbf73", // оранжевый
      5: "#ff7f7f", // красный
      6: "#c9a4ff"  // фиолетовый
    };
    return map[d] || "#cfe9dd";
  }

  function renderTaskRow(t) {
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.gap = "10px";
    row.style.padding = "12px";
    row.style.borderRadius = "14px";
    row.style.background = "#ffffff";
    row.style.boxShadow = "0 6px 18px rgba(0,0,0,0.06)";
    row.style.marginTop = "10px";

    const marker = document.createElement("div");
    marker.style.width = "8px";
    marker.style.height = "34px";
    marker.style.borderRadius = "999px";
    marker.style.background = difficultyColor(t.difficulty);

    const mid = document.createElement("div");
    mid.style.flex = "1";

    const top = document.createElement("div");
    top.style.display = "flex";
    top.style.alignItems = "baseline";
    top.style.gap = "10px";

    const imp = document.createElement("div");
    imp.textContent = String(t.importance);
    imp.style.fontWeight = "800";
    imp.style.color = "#0f4a2d"; // тёмно-зелёный
    imp.style.fontSize = "18px";

    const sphere = document.createElement("div");
    sphere.textContent = t.sphere;
    sphere.style.fontWeight = "700";
    sphere.style.opacity = "0.85";

    top.appendChild(imp);
    top.appendChild(sphere);

    const text = document.createElement("div");
    text.textContent = t.text;
    text.style.marginTop = "2px";
    text.style.fontSize = "15px";

    mid.appendChild(top);
    mid.appendChild(text);

    const box = document.createElement("input");
    box.type = "checkbox";
    box.style.width = "22px";
    box.style.height = "22px";

    box.addEventListener("change", async () => {
      if (!box.checked) return;
      // похвала + салют
      toast(pickPraise());
      confettiLite();

      // выполнить и удалить
      await apiDone(t.id);
      await renderTasks();
    });

    row.appendChild(marker);
    row.appendChild(mid);
    row.appendChild(box);

    return row;
  }

  async function renderTasks() {
    tasksEl.innerHTML = "";
    const tasks = await apiGetTasks();
    if (!tasks.length) {
      tasksEl.innerHTML = `<div class="small">Пока нет задач в работе.</div>`;
      return;
    }
    tasks.forEach(t => tasksEl.appendChild(renderTaskRow(t)));
  }

  btn.addEventListener("click", async () => {
    const tg = window.Telegram && window.Telegram.WebApp;
    if (!tg) {
      show("Telegram WebApp не обнаружен. Открой приложение через кнопку в чате с ботом.");
      return;
    }
    tg.ready();
    const user = tg.initDataUnsafe && tg.initDataUnsafe.user;
    if (!user) {
      show("Telegram WebApp подключён ✅ Но пользователь не передан.");
      return;
    }
    userId = String(user.id);
    show(`Telegram WebApp подключён ✅ Привет, ${user.first_name}! (id: ${userId})`);
    await renderTasks();
  });

  createBtn.addEventListener("click", async () => {
    if (!userId) {
      show("Сначала нажми «Проверить Telegram WebApp».");
      return;
    }
    await apiCreateAndTakeTask();
    await renderTasks();
  });
</script>


</body>
</html>
