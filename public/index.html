<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫</title>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #f7fbff; color: #0b1b14; }
    .wrap { padding: 16px; }
    .card { background: #ffffff; border-radius: 16px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.06); }
    .h1 { font-size: 18px; font-weight: 700; margin: 0 0 8px; }
    .muted { opacity: 0.75; line-height: 1.35; }
    .pill { display: inline-block; padding: 6px 10px; border-radius: 999px; background: #e6f6ef; color: #0f4a2d; font-weight: 600; font-size: 12px; }
    .btn { margin-top: 12px; width: 100%; border: 0; border-radius: 14px; padding: 12px 14px; font-size: 15px; font-weight: 700; background: #d7f3e6; color: #0f4a2d; }
    .small { font-size: 12px; margin-top: 10px; opacity: 0.7; }
  </style>
<script src="https://telegram.org/js/telegram-web-app.js"></script> </head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="pill">v1 ¬∑ —Å–∫–µ–ª–µ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç</div>
      <h1 class="h1">–ü–æ–º–æ—â–Ω–∏–∫ –ü–∞–≤–µ–ª ‚Äî Mini App</h1>
      <div class="muted">
        –ï—Å–ª–∏ —Ç—ã —ç—Ç–æ –≤–∏–¥–∏—à—å ‚Äî –∑–Ω–∞—á–∏—Ç —Ö–æ—Å—Ç–∏–Ω–≥ –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ.
        –î–∞–ª—å—à–µ –º—ã –¥–æ–±–∞–≤–∏–º –ø—Ä–æ–µ–∫—Ç—ã, –∑–∞–¥–∞—á–∏, —Å—Ñ–µ—Ä—ã, —Ü–≤–µ—Ç–∞ –∏ –±–æ—Ç–∞.
      </div>
      <button class="btn" id="btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Telegram WebApp</button>
      <button class="btn" id="create">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
      <div id="createBox" style="margin-top:12px;"></div>
      <div class="small" id="info"></div>
      <div id="tasks" style="margin-top:12px;"></div>
      <div id="takeOverlay" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.35);z-index:9999;align-items:center;justify-content:center;padding:16px;">
  <div style="width:100%;max-width:420px;background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.18);padding:14px;">
    <div style="font-weight:800;font-size:16px;margin-bottom:8px;">–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
      <button id="m1" style="flex:1;border:0;border-radius:14px;padding:10px 12px;font-weight:800;background:#d7f3e6;color:#0f4a2d;">–ë–µ–∑ –¥–∞—Ç—ã</button>
      <button id="m2" style="flex:1;border:0;border-radius:14px;padding:10px 12px;font-weight:800;background:#eef7ff;">–° –¥–∞—Ç–æ–π</button>
      <button id="m3" style="flex:1;border:0;border-radius:14px;padding:10px 12px;font-weight:800;background:#eef7ff;">–î–∞—Ç–∞+–≤—Ä–µ–º—è</button>
    </div>

    <div id="dateWrap" style="display:none;margin-top:8px;">
      <div style="font-size:12px;opacity:.75;margin-bottom:6px;">–î–∞—Ç–∞</div>
      <input id="dueDate" type="date" style="width:100%;padding:12px;border-radius:14px;border:1px solid rgba(0,0,0,0.12);" />
    </div>

    <div id="timeWrap" style="display:none;margin-top:10px;">
      <div style="font-size:12px;opacity:.75;margin-bottom:6px;">–í—Ä–µ–º—è</div>
      <input id="dueTime" type="time" style="width:100%;padding:12px;border-radius:14px;border:1px solid rgba(0,0,0,0.12);" />
    </div>

    <div style="display:flex;gap:8px;margin-top:12px;">
      <button id="cancelTake" style="flex:1;border:0;border-radius:14px;padding:10px 12px;font-weight:800;background:#f3f6fb;">–û—Ç–º–µ–Ω–∞</button>
      <button id="okTake" style="flex:1;border:0;border-radius:14px;padding:10px 12px;font-weight:800;background:#d7f3e6;color:#0f4a2d;">–ì–æ—Ç–æ–≤–æ</button>
    </div>
  </div>
</div>

    </div>
  </div>
  <script>
  const info = document.getElementById("info");
  const btn = document.getElementById("btn");
  const createBtn = document.getElementById("create");
  const tasksEl = document.getElementById("tasks");
  const createBox = document.getElementById("createBox");

  let userId = null;
  let view = "in_work"; // in_work | recorded
let takeTaskId = null;
let takeMode = "1"; // 1=–±–µ–∑ –¥–∞—Ç—ã, 2=–¥–∞—Ç–∞, 3=–¥–∞—Ç–∞+–≤—Ä–µ–º—è

const takeOverlay = document.getElementById("takeOverlay");
const m1 = document.getElementById("m1");
const m2 = document.getElementById("m2");
const m3 = document.getElementById("m3");
const dateWrap = document.getElementById("dateWrap");
const timeWrap = document.getElementById("timeWrap");
const dueDateEl = document.getElementById("dueDate");
const dueTimeEl = document.getElementById("dueTime");
const cancelTake = document.getElementById("cancelTake");
const okTake = document.getElementById("okTake");

function setTakeMode(mode) {
  takeMode = mode;
  m1.style.background = (mode === "1") ? "#d7f3e6" : "#eef7ff";
  m2.style.background = (mode === "2") ? "#d7f3e6" : "#eef7ff";
  m3.style.background = (mode === "3") ? "#d7f3e6" : "#eef7ff";
  dateWrap.style.display = (mode === "2" || mode === "3") ? "block" : "none";
  timeWrap.style.display = (mode === "3") ? "block" : "none";
}

function openTakeOverlay(taskId) {
  takeTaskId = taskId;
  dueDateEl.value = "";
  dueTimeEl.value = "";
  setTakeMode("1");
  takeOverlay.style.display = "flex";
}

function closeTakeOverlay() {
  takeOverlay.style.display = "none";
  takeTaskId = null;
}

m1.onclick = () => setTakeMode("1");
m2.onclick = () => setTakeMode("2");
m3.onclick = () => setTakeMode("3");

cancelTake.onclick = () => closeTakeOverlay();

okTake.onclick = async () => {
  if (!takeTaskId) return;

  let dueDate = null;
  let dueTime = null;

  if (takeMode === "2" || takeMode === "3") {
    dueDate = dueDateEl.value || null;
    if (!dueDate) return; // –±–µ–∑ –¥–∞—Ç—ã –Ω–µ –≤—ã–ø—É—Å–∫–∞–µ–º
  }
  if (takeMode === "3") {
    dueTime = dueTimeEl.value || null;
    if (!dueTime) return; // –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ –≤—ã–ø—É—Å–∫–∞–µ–º
  }

  await fetch(`/api/tasks/${takeTaskId}/take`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ userId, dueDate, dueTime })
  });

  closeTakeOverlay();
  toast("–í —Ä–∞–±–æ—Ç–µ.");
  view = "in_work";
  await renderTasks();
};

  const praise = [
  "–ß—ë—Ç–∫–æ.",
  "–ö—Ä–∞—Å–∏–≤–æ —Å–¥–µ–ª–∞–ª.",
  "–í–æ—Ç —ç—Ç–æ —Ö–æ–¥.",
  "–£–≤–µ—Ä–µ–Ω–Ω–æ.",
  "–ó–∞—Å—á–∏—Ç–∞–Ω–æ —Å –±–æ–Ω—É—Å–æ–º.",
  "–û–ø–∞—Å–Ω–æ –∫—Ä–∞—Å–∏–≤–æ.",
  "–°–∏–ª—å–Ω—ã–π —à–∞–≥.",
  "–¢—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ.",
  "–≠—Ç–æ –ø—Ä–æ–≥—Ä–µ—Å—Å.",
  "–†–æ–≤–Ω–æ –≤ —Ü–µ–ª—å.",
  "–ë–µ–∑ —Å—É–µ—Ç—ã.",
  "–•–æ—Ä–æ—à.",
  "–û—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ.",
  "–≠—Ç–æ –±—ã–ª–æ –≤–∫—É—Å–Ω–æ.",
  "–î–∞. –í–æ—Ç —Ç–∞–∫.",
  "–°–¥–µ–ª–∞–Ω–æ ‚Äî –∏ —Ç–æ—á–∫–∞.",
  "–¢—ã —Ä–∞—Å—Ç—ë—à—å.",
  "–°–º–µ–ª–æ. –ò –ø—Ä–∞–≤–∏–ª—å–Ω–æ.",
  "–≠—Ç–æ —É—Ä–æ–≤–µ–Ω—å."
];
  let lastPraises = [];

function pickPraise() {
  if (praise.length <= 3) {
    return praise[Math.floor(Math.random() * praise.length)];
  }

  let p;
  do {
    p = praise[Math.floor(Math.random() * praise.length)];
  } while (lastPraises.includes(p));

  lastPraises.push(p);
  if (lastPraises.length > 3) {
    lastPraises.shift();
  }

  return p;
}


  function show(msg) {
    info.textContent = msg;
  }
const SPHERES = ["–†–∞–±–æ—Ç–∞","–î–µ–Ω—å–≥–∏","–¢–µ–ª–æ","–û—Ç–Ω–æ—à–µ–Ω–∏—è","–î–æ–º","–†–∞–∑–≤–∏—Ç–∏–µ","–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ","–°–æ—Ü–∏—É–º","–û—Ç–¥—ã—Ö","–¶–µ–Ω–Ω–æ—Å—Ç–∏"];
const DIFFS = [
  { n: 1, label: "–ì–æ–ª—É–±–æ–π" },
  { n: 2, label: "–ó–µ–ª—ë–Ω—ã–π" },
  { n: 3, label: "–ñ—ë–ª—Ç—ã–π" },
  { n: 4, label: "–û—Ä–∞–Ω–∂–µ–≤—ã–π" },
  { n: 5, label: "–ö—Ä–∞—Å–Ω—ã–π" },
  { n: 6, label: "–§–∏–æ–ª–µ—Ç–æ–≤—ã–π" }
];

let draft = { sphere: null, difficulty: null, text: "", importance: null };

function renderCreateUI() {
  if (!userId) {
    createBox.innerHTML = `<div class="small">–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Telegram WebApp¬ª.</div>`;
    return;
  }

  const sphereBtns = SPHERES.map(s => `
    <button data-sphere="${s}" class="sbtn" style="padding:10px 12px;border:0;border-radius:14px;background:${draft.sphere===s?"#d7f3e6":"#eef7ff"};font-weight:700;">
      ${s}
    </button>
  `).join("");

  const diffBtns = DIFFS.map(d => `
    <button data-diff="${d.n}" class="dbtn" style="padding:10px 12px;border:0;border-radius:14px;background:${draft.difficulty===d.n?"#d7f3e6":"#ffffff"};box-shadow:0 6px 18px rgba(0,0,0,0.06);font-weight:800;">
      ${d.n}
    </button>
  `).join("");

  const impBtns = [1,2,3,4].map(n => `
    <button data-imp="${n}" class="ibtn" style="padding:10px 12px;border:0;border-radius:14px;background:${draft.importance===n?"#d7f3e6":"#ffffff"};box-shadow:0 6px 18px rgba(0,0,0,0.06);font-weight:800;color:#0f4a2d;">
      ${n}
    </button>
  `).join("");

  createBox.innerHTML = `
    <div class="card" style="margin-top:12px;">
      <div class="h1">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</div>

      <div class="muted" style="margin-top:8px;">1) –°—Ñ–µ—Ä–∞</div>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;">${sphereBtns}</div>

      <div class="muted" style="margin-top:12px;">2) –°–ª–æ–∂–Ω–æ—Å—Ç—å (1‚Äì6)</div>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;">${diffBtns}</div>

      <div class="muted" style="margin-top:12px;">3) –¢–µ–∫—Å—Ç</div>
      <input id="ttext" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –æ–ø–ª–∞—Ç–∏—Ç—å —Å—á—ë—Ç" value="${draft.text || ""}"
        style="width:100%;margin-top:8px;padding:12px 12px;border-radius:14px;border:1px solid rgba(0,0,0,0.08);font-size:15px;" />

      <div class="muted" style="margin-top:12px;">4) –í–∞–∂–Ω–æ—Å—Ç—å (1‚Äì4)</div>
      <div style="display:flex;gap:8px;margin-top:8px;">${impBtns}</div>

      <button id="saveTask" class="btn" style="margin-top:12px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å (–∑–∞–ø–∏—Å–∞—Ç—å)</button>
      <button id="takeTask" class="btn" style="margin-top:8px;">–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>

      <div class="small" style="margin-top:8px;opacity:.75;">
        –°–Ω–∞—á–∞–ª–∞ ¬´–∑–∞–ø–∏—Å–∞—Ç—å¬ª, –ø–æ—Ç–æ–º ¬´–≤–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É¬ª. –î–∞—Ç—ã –¥–æ–±–∞–≤–∏–º —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º.
      </div>
    </div>
  `;

  // handlers
  createBox.querySelectorAll(".sbtn").forEach(b => b.addEventListener("click", () => {
    draft.sphere = b.dataset.sphere;
    renderCreateUI();
  }));

  createBox.querySelectorAll(".dbtn").forEach(b => b.addEventListener("click", () => {
    draft.difficulty = Number(b.dataset.diff);
    renderCreateUI();
  }));

  createBox.querySelectorAll(".ibtn").forEach(b => b.addEventListener("click", () => {
    draft.importance = Number(b.dataset.imp);
    renderCreateUI();
  }));

  const ttext = createBox.querySelector("#ttext");
  ttext.addEventListener("input", () => {
    draft.text = ttext.value;
  });

  createBox.querySelector("#saveTask").addEventListener("click", async () => {
    if (!draft.sphere || !draft.difficulty || !draft.importance || !draft.text.trim()) {
      show("–ó–∞–ø–æ–ª–Ω–∏: —Å—Ñ–µ—Ä–∞, —Å–ª–æ–∂–Ω–æ—Å—Ç—å, —Ç–µ–∫—Å—Ç, –≤–∞–∂–Ω–æ—Å—Ç—å.");
      return;
    }
    const r = await fetch("/api/tasks", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId,
        sphere: draft.sphere,
        difficulty: draft.difficulty,
        importance: draft.importance,
        text: draft.text.trim()
      })
    });
    const data = await r.json();
    if (data.error) { show("–û—à–∏–±–∫–∞: " + data.error); return; }
    show("–ó–∞–ø–∏—Å–∞–ª ‚úÖ –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—à—å –≤–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É.");
    draft._lastCreatedId = data.task.id;
  });

  createBox.querySelector("#takeTask").addEventListener("click", async () => {
  const id = draft._lastCreatedId;
  if (!id) {
    show("–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å (–∑–∞–ø–∏—Å–∞—Ç—å)¬ª.");
    return;
  }
  openTakeOverlay(id);
});
}

  function confettiLite() {
    // –û—á–µ–Ω—å –ª—ë–≥–∫–∏–π "—Å–∞–ª—é—Ç" –±–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫
    const n = 40;
    for (let i = 0; i < n; i++) {
      const dot = document.createElement("div");
      dot.style.position = "fixed";
      dot.style.left = (50 + (Math.random() * 20 - 10)) + "vw";
      dot.style.top = (30 + (Math.random() * 10 - 5)) + "vh";
      dot.style.width = "6px";
      dot.style.height = "6px";
      dot.style.borderRadius = "999px";
      dot.style.background = "rgba(60, 160, 120, 0.8)";
      dot.style.zIndex = 9999;
      dot.style.transform = "translate(-50%, -50%)";
      dot.style.transition = "transform 700ms ease, opacity 700ms ease";
      document.body.appendChild(dot);

      requestAnimationFrame(() => {
        dot.style.opacity = "0";
        dot.style.transform =
          `translate(${(Math.random() * 160 - 80)}px, ${(Math.random() * 220 - 120)}px)`;
      });

      setTimeout(() => dot.remove(), 1400);
    }
  }

  function toast(text) {
    const t = document.createElement("div");
    t.textContent = text;
    t.style.position = "fixed";
    t.style.left = "50%";
    t.style.bottom = "90px";
    t.style.transform = "translateX(-50%)";
    t.style.background = "#ffffff";
    t.style.borderRadius = "999px";
    t.style.padding = "10px 14px";
    t.style.boxShadow = "0 10px 30px rgba(0,0,0,0.12)";
    t.style.fontWeight = "700";
    t.style.zIndex = 9999;
    t.style.opacity = "0";
    t.style.transition = "opacity 200ms ease";
    document.body.appendChild(t);
    requestAnimationFrame(() => (t.style.opacity = "1"));
    setTimeout(() => {
      t.style.opacity = "0";
      setTimeout(() => t.remove(), 250);
    }, 2200);
  }
async function takeWithSchedule(taskId) {
  const mode = prompt(
    "–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É:\n1 ‚Äî –±–µ–∑ –¥–∞—Ç—ã\n2 ‚Äî —Å –¥–∞—Ç–æ–π\n3 ‚Äî —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º\n\n–í–≤–µ–¥–∏ 1, 2 –∏–ª–∏ 3:",
    "1"
  );

  if (mode === null) return;

  let dueDate = null;
  let dueTime = null;

  if (mode === "2" || mode === "3") {
    dueDate = prompt("–í–≤–µ–¥–∏ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î:");
    if (!dueDate) return;
  }

  if (mode === "3") {
    dueTime = prompt("–í–≤–µ–¥–∏ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ß–ß:–ú–ú:");
    if (!dueTime) return;
  }

  await fetch(`/api/tasks/${taskId}/take`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ userId, dueDate, dueTime })
  });

  toast("–í —Ä–∞–±–æ—Ç–µ.");
  view = "in_work";
  await renderTasks();
}

  async function apiGetTasks() {
  const r = await fetch(`/api/tasks?userId=${encodeURIComponent(userId)}&status=${encodeURIComponent(view)}`);
  const data = await r.json();
  return data.tasks || [];
}

  async function apiCreateAndTakeTask() {
    const body = {
      userId,
      sphere: "–î–µ–Ω—å–≥–∏",
      difficulty: 3,
      importance: 1,
      text: "–¢–µ—Å—Ç: –æ–ø–ª–∞—Ç–∏—Ç—å —Å—á—ë—Ç"
    };
    const r = await fetch("/api/tasks", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    const created = await r.json();
    const task = created.task;

    await fetch(`/api/tasks/${task.id}/take`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, dueDate: null, dueTime: null })
    });
  }

  async function apiDone(taskId) {
    await fetch(`/api/tasks/${taskId}/done`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId })
    });
  }

  function difficultyColor(d) {
    // –ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞ —Å–ª–µ–≤–∞ (–ø–æ–∑–∂–µ —Å–¥–µ–ª–∞–µ–º —Ç–≤–æ–∏ —Ç–æ—á–Ω—ã–µ —Ü–≤–µ—Ç–∞)
    const map = {
      1: "#7fd3ff", // –≥–æ–ª—É–±–æ–π
      2: "#7be3b0", // –∑–µ–ª—ë–Ω—ã–π
      3: "#ffe27a", // –∂—ë–ª—Ç—ã–π
      4: "#ffbf73", // –æ—Ä–∞–Ω–∂–µ–≤—ã–π
      5: "#ff7f7f", // –∫—Ä–∞—Å–Ω—ã–π
      6: "#c9a4ff"  // —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
    };
    return map[d] || "#cfe9dd";
  }

  function renderTaskRow(t) {
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.gap = "10px";
    row.style.padding = "12px";
    row.style.borderRadius = "14px";
    row.style.background = "#ffffff";
    row.style.boxShadow = "0 6px 18px rgba(0,0,0,0.06)";
    row.style.marginTop = "10px";

    const marker = document.createElement("div");
    marker.style.width = "8px";
    marker.style.height = "34px";
    marker.style.borderRadius = "999px";
    marker.style.background = difficultyColor(t.difficulty);

    const mid = document.createElement("div");
    mid.style.flex = "1";

    const top = document.createElement("div");
    top.style.display = "flex";
    top.style.alignItems = "baseline";
    top.style.gap = "10px";

    const imp = document.createElement("div");
    imp.textContent = String(t.importance);
    imp.style.fontWeight = "800";
    imp.style.color = "#0f4a2d"; // —Ç—ë–º–Ω–æ-–∑–µ–ª—ë–Ω—ã–π
    imp.style.fontSize = "18px";

    const sphere = document.createElement("div");
    sphere.textContent = t.sphere;
    sphere.style.fontWeight = "700";
    sphere.style.opacity = "0.85";

    top.appendChild(imp);
    top.appendChild(sphere);

    const text = document.createElement("div");
    text.textContent = t.text;
    text.style.marginTop = "2px";
    text.style.fontSize = "15px";

    const when = document.createElement("div");
when.style.marginTop = "4px";
when.style.fontSize = "12px";
when.style.opacity = "0.7";

if (t.dueDate && t.dueTime) {
  when.textContent = `‚è∞ ${t.dueDate} ${t.dueTime}`;
} else if (t.dueDate) {
  when.textContent = `üìÖ ${t.dueDate}`;
} else {
  when.textContent = "";
}

mid.appendChild(top);
mid.appendChild(text);
mid.appendChild(when);


  let right;
if (view === "in_work") {
  right = document.createElement("input");
  right.type = "checkbox";
  right.style.width = "22px";
  right.style.height = "22px";

  right.addEventListener("change", async () => {
    if (!right.checked) return;
    toast(pickPraise());
    confettiLite();
    await apiDone(t.id);
    await renderTasks();
  });
} else {
  right = document.createElement("button");
  right.textContent = "–í —Ä–∞–±–æ—Ç—É";
  right.style.border = "0";
  right.style.borderRadius = "12px";
  right.style.padding = "10px 12px";
  right.style.fontWeight = "800";
  right.style.background = "#d7f3e6";
  right.style.color = "#0f4a2d";

 right.onclick = () => {
  openTakeOverlay(t.id);
};
}


    row.appendChild(marker);
    row.appendChild(mid);
    row.appendChild(right);

    return row;
  }

  async function renderTasks() {
    tasksEl.innerHTML = `
  <div style="display:flex;gap:8px;margin-top:10px;">
    <button id="vw1" class="btn" style="margin:0;background:${view==="in_work"?"#d7f3e6":"#eef7ff"};">–í —Ä–∞–±–æ—Ç–µ</button>
    <button id="vw2" class="btn" style="margin:0;background:${view==="recorded"?"#d7f3e6":"#eef7ff"};">–ó–∞–ø–∏—Å–∞–Ω–Ω—ã–µ</button>
  </div>
`;
document.getElementById("vw1").onclick = async () => { view = "in_work"; await renderTasks(); };
document.getElementById("vw2").onclick = async () => { view = "recorded"; await renderTasks(); };
    const tasks = await apiGetTasks();
   if (!tasks.length) {
  const emptyText = (view === "recorded")
    ? "–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á."
    : "–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á –≤ —Ä–∞–±–æ—Ç–µ.";

  const empty = document.createElement("div");
  empty.className = "small";
  empty.style.marginTop = "10px";
  empty.textContent = emptyText;

  tasksEl.appendChild(empty);
  return;
}
    tasks.forEach(t => tasksEl.appendChild(renderTaskRow(t)));
  }

  btn.addEventListener("click", async () => {
    const tg = window.Telegram && window.Telegram.WebApp;
    if (!tg) {
      show("Telegram WebApp –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω. –û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ —á–∞—Ç–µ —Å –±–æ—Ç–æ–º.");
      return;
    }
    tg.ready();
    const user = tg.initDataUnsafe && tg.initDataUnsafe.user;
    if (!user) {
      show("Telegram WebApp –ø–æ–¥–∫–ª—é—á—ë–Ω ‚úÖ –ù–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω.");
      return;
    }
    userId = String(user.id);
    show(`Telegram WebApp –ø–æ–¥–∫–ª—é—á—ë–Ω ‚úÖ –ü—Ä–∏–≤–µ—Ç, ${user.first_name}! (id: ${userId})`);
    await renderTasks();
    renderCreateUI();
  });

  createBtn.addEventListener("click", async () => {
    if (!userId) {
      show("–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Telegram WebApp¬ª.");
      return;
    }
    await apiCreateAndTakeTask();
    await renderTasks();
  });
</script>


</body>
</html>
